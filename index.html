<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Karte mit Markierungen</title>

  <!-- üéÉ Favicon -->
  <link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/BattleNogare/lostparadise_halloween_2025/main/halloween_fav.ico">

  <style>
    html, body {
      margin:0;
      font-family:system-ui, sans-serif;
      background:#fafafa;
      height:100%;
    }

    #wrap {
      display:flex;
      flex-direction:column;
      min-height:100vh;
      max-width:100%;
    }

    /* === Header === */
    header {
      padding:8px 12px;
      background:#f5f5f5;
      border-bottom:1px solid #ddd;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }

    #toolbar {
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    .btn {
      padding:6px 10px;
      border:1px solid #ccc;
      border-radius:6px;
      background:#fff;
      cursor:pointer;
    }
    .btn:active { transform: translateY(1px); }

    .hint {
      color:#666;
      font-size:0.9em;
    }

    /* Logo rechts oben */
    #logo {
      display:flex;
      align-items:center;
      justify-content:center;
      height:40px;
    }
    #logo img {
      height:40px;
      width:auto;
      display:block;
    }

    /* === Hauptbereich === */
    #main {
      flex:1;
      display:flex;
      min-height:0;
      padding:12px;
      gap:12px;
      box-sizing:border-box;
    }

    /* Karte mit Rahmen */
    #stageWrapper {
      flex:1;
      min-width:0;
      display:flex;
    }

    #stage {
      flex:1;
      border:3px solid #333;
      border-radius:10px;
      background:#fff;
      overflow:hidden;
      height:80vh;
      max-height:80vh;
      max-width:100%;
      position:relative;
      box-shadow:0 0 10px rgba(0,0,0,0.15);
    }

    #svgRoot {
      width:100%;
      height:100%;
      background:#fff;
      touch-action:none;
    }

    /* === History rechts === */
    #history {
      width:240px;
      max-width:240px;
      flex:none;
      display:flex;
      flex-direction:column;
      border:1px solid #ccc;
      border-radius:8px;
      background:#fff;
      max-height:80vh;
      box-shadow:0 0 6px rgba(0,0,0,0.1);
    }

    #historyHeader {
      padding:8px 10px;
      border-bottom:1px solid #ddd;
      font-weight:600;
      font-size:0.9rem;
      background:#f5f5f5;
      text-align:center;
    }

    #historyList {
      flex:1;
      overflow:auto;
      font-size:0.9rem;
      line-height:1.4;
      padding:8px 10px;
    }

    .historyItem {
      padding:6px 8px;
      border-radius:4px;
      cursor:grab;
      user-select:none;
      border:1px solid transparent;
      margin-bottom:6px;
      background:#fff;
    }
    .historyItem:hover {
      background:#eee;
    }

    /* Marker Styles */
    .marker { cursor:grab; }
    .marker:active { cursor:grabbing; }

    .marker circle {
      stroke:#000;
      stroke-width:1;
      fill:rgba(255,0,0,.85);
      transition:fill .1s, stroke .1s, stroke-width .1s;
    }

    .marker.highlight circle {
      fill:rgba(255,255,0,.6);
      stroke:#ff0;
      stroke-width:3;
    }

    #svgRoot * { pointer-events:visiblePainted; }
    #markerLayer { pointer-events:none; }
    #markerLayer > g { pointer-events:auto; }
  </style>
</head>
<body>
<div id="wrap">

  <header>
    <div id="toolbar">
      <button id="addMode" class="btn">‚ûï Markieren</button>
      <button id="selectMode" class="btn">üñ±Ô∏è Verschieben / Ausblenden</button>

      <label class="hint">Marker-Gr√∂√üe:
        <input id="sizeInput" type="number" step="0.05" min="0.1" value="0.2" style="width:4em;">
      </label>

      <span class="hint">
        Scroll = Zoom (schnell) ‚Ä¢ Leertaste+Ziehen / Rechtsklick+Ziehen = Pan ‚Ä¢
        Linksklick halten = verschieben ‚Ä¢ Shift+Linksklick = Label setzen ‚Ä¢ Shift+Rechtsklick = ausblenden
      </span>
    </div>

    <!-- üéÉ Logo rechts -->
    <div id="logo">
      <img src="https://raw.githubusercontent.com/BattleNogare/lostparadise_halloween_2025/main/halloween.png" alt="Halloween Logo">
    </div>
  </header>

  <div id="main">
    <div id="stageWrapper">
      <div id="stage">
        <svg id="svgRoot" xmlns="http://www.w3.org/2000/svg"></svg>
      </div>
    </div>

    <aside id="history">
      <div id="historyHeader">History</div>
      <div id="historyList"></div>
    </aside>
  </div>

</div>

<script>
(function(){
  // === Konfiguration ===
  const SVG_PATH = 'https://raw.githubusercontent.com/BattleNogare/lostparadise_halloween_2025/main/map.svg';
  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyUq4LMZhjRkzG2pwmNrgG1GdLjFi6H3bivz_2SEDYA0m9_lMrPQjxdFmEo0ukgdeCKKA/exec';
  const TOKEN = null; // optional
  const STORAGE_KEY = 'markers.v1';

  const ZOOM_FACTOR = 1.4; // schnelleres Zoomen
  const ZOOM_MAX = 20; 
  let MARKER_SCALE = 0.2;

  let mode = 'add';
  let svg, markerLayer, vb, baseViewBox;
  let isPanning = false, panStart = null, panStartVB = null, spacePressed = false;
  let markers = [];
  let markerDomMap = {};

  const $ = (sel, el=document) => el.querySelector(sel);
  $('#addMode').onclick = () => setMode('add');
  $('#selectMode').onclick = () => setMode('select');
  $('#sizeInput').oninput = (e) => {
    MARKER_SCALE = Math.max(0.1, parseFloat(e.target.value) || MARKER_SCALE);
    renderMarkers();
  };
  setMode('add');

  fetch(SVG_PATH).then(r=>r.text()).then(txt=>{
    $('#svgRoot').outerHTML = txt
      .replace('<svg','<svg id="svgRoot" style="width:100%; height:100%; touch-action:none;"')
      .replace('</svg>','<g id="markerLayer"></g></svg>');
    svg=$('#svgRoot'); markerLayer=$('#markerLayer');

    if(!svg.getAttribute('viewBox')){
      const w=parseFloat(svg.getAttribute('width'))||1000;
      const h=parseFloat(svg.getAttribute('height'))||1000;
      svg.setAttribute('viewBox',`0 0 ${w} ${h}`);
    }
    const [x,y,w,h]=svg.getAttribute('viewBox').split(/\s+/).map(Number);
    vb={x,y,width:w,height:h};
    baseViewBox={...vb};

    svg.addEventListener('click',onSvgBackgroundClick);
    svg.addEventListener('wheel',onWheel,{passive:false});
    svg.addEventListener('mousedown',onMouseDown);
    window.addEventListener('mousemove',onMouseMove);
    window.addEventListener('mouseup',onMouseUp);
    window.addEventListener('keydown',e=>{if(e.code==='Space'){spacePressed=true;e.preventDefault();}});
    window.addEventListener('keyup',e=>{if(e.code==='Space'){spacePressed=false;}});
    window.addEventListener('contextmenu',e=>{if(isPanning)e.preventDefault();});

    loadFromSheet().catch(()=>{loadLocal();renderMarkers();});
  });

  function setMode(m){mode=m;$('#addMode').style.fontWeight=(m==='add')?'600':'400';$('#selectMode').style.fontWeight=(m==='select')?'600':'400';}

  function clientToBasePercent(evt){
    const pt=svg.createSVGPoint();pt.x=evt.clientX;pt.y=evt.clientY;
    const sp=pt.matrixTransform(svg.getScreenCTM().inverse());
    const px=(sp.x-baseViewBox.x)/baseViewBox.width*100;
    const py=(sp.y-baseViewBox.y)/baseViewBox.height*100;
    return {px:Math.min(100,Math.max(0,px)),py:Math.min(100,Math.max(0,py))};
  }
  function percentToAbsXY(m){
    return {absX:baseViewBox.x+(m.px/100)*baseViewBox.width,absY:baseViewBox.y+(m.py/100)*baseViewBox.height};
  }

  function onSvgBackgroundClick(evt){
    if(mode!=='add')return;
    if(evt.target.closest&&evt.target.closest('#markerLayer'))return;
    const {px,py}=clientToBasePercent(evt);
    const m=createMarker(px,py); saveLocal(); upsertRemote(m); renderMarkers();
  }
  function createMarker(px,py){
    const id=crypto.randomUUID?crypto.randomUUID():'m'+Date.now()+Math.random();
    const m={id,px,py,label:"",visible:1};markers.push(m);return m;
  }

  function renderMarkers(){
    markerLayer.innerHTML=''; markerDomMap={};
    const baseR=Math.max(baseViewBox.width,baseViewBox.height)*0.006*MARKER_SCALE;
    markers.filter(m=>m.visible!==0).forEach(m=>{
      const {absX,absY}=percentToAbsXY(m);
      const g=document.createElementNS('http://www.w3.org/2000/svg','g');
      g.classList.add('marker'); g.dataset.id=m.id;
      const circle=document.createElementNS('http://www.w3.org/2000/svg','circle');
      circle.setAttribute('cx',absX);circle.setAttribute('cy',absY);circle.setAttribute('r',baseR);
      g.appendChild(circle); markerLayer.appendChild(g); markerDomMap[m.id]=g;
      let dragging=false;
      g.addEventListener('mousedown',e=>{
        if(mode!=='select')return;
        if(e.button===0){
          if(e.shiftKey){
            e.preventDefault();
            const newLabel=prompt('Label:',m.label||'')??m.label;
            m.label=newLabel; saveLocal(); upsertRemote(m); renderMarkers(); return;
          } else { dragging=true; e.preventDefault(); }
        }
      });
      window.addEventListener('mousemove',e=>{
        if(!dragging)return;
        const p=clientToBasePercent(e); m.px=p.px; m.py=p.py; updateMarkerNode(g,m,baseR);
      });
      window.addEventListener('mouseup',()=>{
        if(!dragging)return;
        dragging=false; saveLocal(); upsertRemote(m); renderMarkers();
      });
      g.addEventListener('contextmenu',e=>{
        if(mode!=='select')return;
        if(e.shiftKey){e.preventDefault();m.visible=0;saveLocal();upsertRemote(m);renderMarkers();}
      });
    });
    rebuildHistory();
  }

  function updateMarkerNode(g,m,r){
    const {absX,absY}=percentToAbsXY(m);
    const c=g.querySelector('circle');
    c.setAttribute('cx',absX);c.setAttribute('cy',absY);
    if(r)c.setAttribute('r',r);
  }

  function rebuildHistory(){
    const list=$('#historyList'); list.innerHTML='';
    markers.filter(m=>m.visible!==0&&m.label.trim()!=='').slice().reverse().forEach(m=>{
      const item=document.createElement('div');item.className='historyItem';item.textContent=m.label;item.dataset.id=m.id;
      let pressed=false;
      item.addEventListener('mousedown',e=>{
        if(e.button!==0)return;
        pressed=true;highlightMarker(m.id,true);e.preventDefault();
      });
      window.addEventListener('mouseup',()=>{
        if(!pressed)return;
        pressed=false;highlightMarker(m.id,false);
      });
      list.appendChild(item);
    });
  }
  function highlightMarker(id,on){
    const g=markerDomMap[id];if(!g)return;
    if(on)g.classList.add('highlight');else g.classList.remove('highlight');
  }

  function clampAndSetViewBox(x,y,w,h){
    if(w>baseViewBox.width)w=baseViewBox.width;
    if(h>baseViewBox.height)h=baseViewBox.height;
    const minX=baseViewBox.x,maxX=baseViewBox.x+baseViewBox.width-w;
    const minY=baseViewBox.y,maxY=baseViewBox.y+baseViewBox.height-h;
    if(x<minX)x=minX;if(x>maxX)x=maxX;if(y<minY)y=minY;if(y>maxY)y=maxY;
    vb={x,y,width:w,height:h};svg.setAttribute('viewBox',`${x} ${y} ${w} ${h}`);
  }
  function onWheel(e){
    e.preventDefault();
    const pt=svg.createSVGPoint();pt.x=e.clientX;pt.y=e.clientY;
    const sp=pt.matrixTransform(svg.getScreenCTM().inverse());
    const scale=(e.deltaY<0)?(1/ZOOM_FACTOR):ZOOM_FACTOR;
    let newW=vb.width*scale,newH=vb.height*scale;
    const minW=baseViewBox.width/ZOOM_MAX,minH=baseViewBox.height/ZOOM_MAX;
    if(newW<minW)newW=minW;if(newH<minH)newH=minH;
    const maxW=baseViewBox.width,maxH=baseViewBox.height;
    if(newW>maxW)newW=maxW;if(newH>maxH)newH=maxH;
    const kx=(sp.x-vb.x)/vb.width,ky=(sp.y-vb.y)/vb.height;
    const newX=sp.x-kx*newW,newY=sp.y-ky*newH;
    clampAndSetViewBox(newX,newY,newW,newH);
  }
  function onMouseDown(e){
    if((e.button===0&&spacePressed)||e.button===2){
      isPanning=true;panStart={x:e.clientX,y:e.clientY};panStartVB={...vb};e.preventDefault();
    }
  }
  function onMouseMove(e){
    if(!isPanning)return;
    const dx=e.clientX-panStart.x,dy=e.clientY-panStart.y;
    const m=svg.getScreenCTM();
    const scaleX=vb.width/(m.a*svg.clientWidth);
    const scaleY=vb.height/(m.d*svg.clientHeight);
    const newX=panStartVB.x-dx*scaleX,newY=panStartVB.y-dy*scaleY;
    clampAndSetViewBox(newX,newY,vb.width,vb.height);
  }
  function onMouseUp(){isPanning=false;}

  function saveLocal(){localStorage.setItem(STORAGE_KEY,JSON.stringify(markers));}
  function loadLocal(){try{markers=JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');}catch(e){markers=[];}}

  async function loadFromSheet(){
    const qs=TOKEN?`?token=${encodeURIComponent(TOKEN)}&t=${Date.now()}`:`?t=${Date.now()}`;
    const res=await fetch(WEB_APP_URL+qs);if(!res.ok)throw new Error('GET fail');
    const data=await res.json();
    markers=Array.isArray(data.markers)?data.markers.map(m=>({
      id:m.id,px:+m.px,py:+m.py,label:m.label||'',visible:(m.visible===0?0:1)
    })):[];
    saveLocal();renderMarkers();
  }

  function formBody(params){
    const p=new URLSearchParams();Object.entries(params).forEach(([k,v])=>p.set(k,v));
    if(TOKEN)p.set('token',TOKEN);return p.toString();
  }
  async function upsertRemote(m){
    const res=await fetch(WEB_APP_URL,{
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body:formBody({action:'upsert',payload:JSON.stringify({
        id:m.id,px:m.px,py:m.py,label:m.label||'',visible:(m.visible===0?0:1)
      })})
    });
    if(!res.ok)console.warn('upsert fail');
  }
})();
</script>
</body>
</html>
