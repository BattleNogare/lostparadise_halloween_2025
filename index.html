<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Karte mit Markierungen</title>

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/BattleNogare/lostparadise_halloween_2025/main/halloween_fav.ico">

  <style>
    html, body {
      margin:0;
      font-family:system-ui, sans-serif;
      background:#fafafa;
      height:100%;
    }

    #wrap {
      display:flex;
      flex-direction:column;
      min-height:100vh;
      max-width:100%;
    }

    header {
      padding:8px 12px;
      background:#f5f5f5;
      border-bottom:1px solid #ddd;
      display:flex;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      row-gap:8px;
    }

    #toolbar {
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
      max-width:calc(100% - 60px);
    }

    .hint {
      color:#444;
      font-size:0.8rem;
      line-height:1.4;
      max-width:600px;
    }

    #logo {
      display:flex;
      align-items:center;
      justify-content:center;
      height:40px;
      flex:none;
    }
    #logo img {
      height:40px;
      width:auto;
      display:block;
    }

    #main {
      flex:1;
      display:flex;
      min-height:0;
      padding:12px;
      gap:12px;
      box-sizing:border-box;
    }

    #stageWrapper {
      flex:1;
      min-width:0;
      display:flex;
    }

    #stage {
      flex:1;
      border:3px solid #333;
      border-radius:10px;
      background:#fff;
      overflow:hidden;
      height:80vh;
      max-height:80vh;
      max-width:100%;
      position:relative;
      box-shadow:0 0 10px rgba(0,0,0,0.15);
    }

    #svgRoot {
      width:100%;
      height:100%;
      background:#fff;
      touch-action:none;
    }

    #history {
      width:240px;
      max-width:240px;
      flex:none;
      display:flex;
      flex-direction:column;
      border:1px solid #ccc;
      border-radius:8px;
      background:#fff;
      max-height:80vh;
      box-shadow:0 0 6px rgba(0,0,0,0.1);
      font-size:0.9rem;
      line-height:1.4;
    }

    #historyHeader {
      padding:8px 10px;
      border-bottom:1px solid #ddd;
      font-weight:600;
      background:#f5f5f5;
      text-align:center;
      font-size:0.9rem;
    }

    #historyList {
      flex:1;
      overflow:auto;
      padding:8px 10px;
    }

    .historyItem {
      padding:6px 8px;
      border-radius:4px;
      cursor:grab;
      user-select:none;
      border:1px solid transparent;
      margin-bottom:6px;
      background:#fff;
      font-size:0.85rem;
    }
    .historyItem:hover {
      background:#eee;
    }

    .marker {
      cursor:grab;
    }
    .marker:active {
      cursor:grabbing;
    }

    .marker circle {
      stroke:#000;
      stroke-width:1;
      fill:rgba(255,0,0,.85);
      transition:fill .1s, stroke .1s, stroke-width .1s;
    }

    .marker.highlight circle {
      fill:rgba(255,255,0,.6);
      stroke:#ff0;
      stroke-width:3;
    }

    #svgRoot * { pointer-events:visiblePainted; }
    #markerLayer { pointer-events:none; }
    #markerLayer > g { pointer-events:auto; }
  </style>
</head>
<body>
<div id="wrap">

  <header>
    <div id="toolbar">
      <div class="hint">
        Shift + Linksklick = Marker setzen •
        Linksklick halten = verschieben •
        Shift + Rechtsklick = löschen (ausblenden) •
        Scroll = Zoom •
        Leertaste+Ziehen / Rechtsklick+Ziehen = Pan
      </div>
    </div>

    <div id="logo">
      <img src="https://raw.githubusercontent.com/BattleNogare/lostparadise_halloween_2025/main/halloween.png" alt="Halloween Logo">
    </div>
  </header>

  <div id="main">
    <div id="stageWrapper">
      <div id="stage">
        <svg id="svgRoot" xmlns="http://www.w3.org/2000/svg"></svg>
      </div>
    </div>

    <aside id="history">
      <div id="historyHeader">History</div>
      <div id="historyList"></div>
    </aside>
  </div>

</div>

<script>
(function(){
  const SVG_PATH='https://raw.githubusercontent.com/BattleNogare/lostparadise_halloween_2025/main/map.svg';
  const WEB_APP_URL='https://script.google.com/macros/s/AKfycbyUq4LMZhjRkzG2pwmNrgG1GdLjFi6H3bivz_2SEDYA0m9_lMrPQjxdFmEo0ukgdeCKKA/exec';
  const TOKEN=null;
  const STORAGE_KEY='markers.v1';

  const ZOOM_FACTOR=1.4, ZOOM_MAX=20;
  const SCALE_OUT=1.0, SCALE_IN=0.2;

  let svg,markerLayer,vb,baseViewBox;
  let isPanning=false,panStart=null,panStartVB=null,spacePressed=false;
  let markers=[],markerDomMap={};

  let nextIdNumber=1;
  const getNextId=()=>String(nextIdNumber++).padStart(4,'0');
  const $=(s,e=document)=>e.querySelector(s);

  fetch(SVG_PATH).then(r=>r.text()).then(txt=>{
    $('#svgRoot').outerHTML=txt.replace('<svg','<svg id="svgRoot" style="width:100%;height:100%;touch-action:none;"').replace('</svg>','<g id="markerLayer"></g></svg>');
    svg=$('#svgRoot');markerLayer=$('#markerLayer');
    const stageEl=document.getElementById('stage');
    stageEl.addEventListener('contextmenu',e=>e.preventDefault());
    svg.addEventListener('contextmenu',e=>e.preventDefault());
    if(!svg.getAttribute('viewBox')){const w=parseFloat(svg.getAttribute('width'))||1000,h=parseFloat(svg.getAttribute('height'))||1000;svg.setAttribute('viewBox',`0 0 ${w} ${h}`);}
    const [x,y,w,h]=svg.getAttribute('viewBox').split(/\s+/).map(Number);
    vb={x,y,width:w,height:h};baseViewBox={...vb};
    svg.addEventListener('click',onSvgClickAdd);
    svg.addEventListener('wheel',onWheel,{passive:false});
    svg.addEventListener('mousedown',onMouseDownPanOrMarkerStart);
    window.addEventListener('mousemove',onMouseMoveAll);
    window.addEventListener('mouseup',onMouseUpAll);
    window.addEventListener('keydown',e=>{if(e.code==='Space'){spacePressed=true;e.preventDefault();}});
    window.addEventListener('keyup',e=>{if(e.code==='Space')spacePressed=false;});
    loadFromSheet().catch(()=>{loadLocal();updateNextId();renderMarkers();});
  });

  function updateNextId(){
    const ids=markers.map(m=>parseInt(m.id,10)).filter(n=>!isNaN(n));
    nextIdNumber=(ids.length?Math.max(...ids)+1:1);
  }

  function clientToBasePercent(evt){
    const pt=svg.createSVGPoint();pt.x=evt.clientX;pt.y=evt.clientY;
    const sp=pt.matrixTransform(svg.getScreenCTM().inverse());
    const px=(sp.x-baseViewBox.x)/baseViewBox.width*100;
    const py=(sp.y-baseViewBox.y)/baseViewBox.height*100;
    return{px:Math.min(100,Math.max(0,px)),py:Math.min(100,Math.max(0,py))};
  }
  function percentToAbsXY(m){return{absX:baseViewBox.x+(m.px/100)*baseViewBox.width,absY:baseViewBox.y+(m.py/100)*baseViewBox.height};}
  function getCurrentMarkerRadius(){
    const zoomFactor=baseViewBox.width/vb.width;
    const t=(zoomFactor-1)/(ZOOM_MAX-1);
    const scaleNow=SCALE_OUT*(1-t)+SCALE_IN*t;
    return Math.max(baseViewBox.width,baseViewBox.height)*0.006*scaleNow;
  }

  function onSvgClickAdd(evt){
    if(!evt.shiftKey)return;
    if(evt.target.closest&&evt.target.closest('#markerLayer'))return;
    const{px,py}=clientToBasePercent(evt);
    const m=createMarker(px,py);
    saveLocal();upsertRemote(m);renderMarkers();
  }
  function createMarker(px,py){const m={id:getNextId(),px,py,visible:true,createdAt:Date.now()};markers.push(m);return m;}
  function renderMarkers(){
    markerLayer.innerHTML='';markerDomMap={};
    const r=getCurrentMarkerRadius();
    markers.filter(m=>m.visible).forEach(m=>{
      const{absX,absY}=percentToAbsXY(m);
      const g=document.createElementNS('http://www.w3.org/2000/svg','g');
      g.classList.add('marker');g.dataset.id=m.id;
      const c=document.createElementNS('http://www.w3.org/2000/svg','circle');
      c.setAttribute('cx',absX);c.setAttribute('cy',absY);c.setAttribute('r',r);
      g.appendChild(c);markerLayer.appendChild(g);markerDomMap[m.id]=g;
      attachMarkerInteractions(g,m);
    });
    rebuildHistory();
  }
  function attachMarkerInteractions(g,m){
    let dragging=false;
    g.addEventListener('mousedown',e=>{
      if(e.button===0&&!e.shiftKey){dragging=true;e.preventDefault();}
      if(e.button===2&&e.shiftKey){e.preventDefault();m.visible=false;saveLocal();upsertRemote(m);renderMarkers();}
    });
    g._dragMarkerRef=m;g._isDragging=()=>dragging;g._stopDragging=()=>{dragging=false;};
  }
  function dragMoveMarkerIfNeeded(evt){
    for(const id in markerDomMap){
      const g=markerDomMap[id],m=markers.find(x=>x.id===id);
      if(!m||!g._isDragging||!g._isDragging())continue;
      const p=clientToBasePercent(evt);m.px=p.px;m.py=p.py;
      const{absX,absY}=percentToAbsXY(m);g.querySelector('circle').setAttribute('cx',absX);g.querySelector('circle').setAttribute('cy',absY);
    }
  }
  function dragStopIfNeeded(){
    for(const id in markerDomMap){
      const g=markerDomMap[id],m=markers.find(x=>x.id===id);
      if(!m||!g._isDragging||!g._isDragging())continue;
      g._stopDragging();saveLocal();upsertRemote(m);renderMarkers();
    }
  }
  function rebuildHistory(){
    const list=$('#historyList');list.innerHTML='';
    markers.filter(m=>m.visible).slice().sort((a,b)=>b.createdAt-a.createdAt).forEach(m=>{
      const item=document.createElement('div');
      item.className='historyItem';item.textContent='Marker '+m.id;item.dataset.id=m.id;
      let pressed=false;
      item.addEventListener('mousedown',e=>{if(e.button!==0)return;pressed=true;highlightMarker(m.id,true);e.preventDefault();});
      window.addEventListener('mouseup',()=>{if(!pressed)return;pressed=false;highlightMarker(m.id,false);});
      list.appendChild(item);
    });
  }
  function highlightMarker(id,on){const g=markerDomMap[id];if(!g)return;if(on)g.classList.add('highlight');else g.classList.remove('highlight');}
  function clampAndSetViewBox(x,y,w,h){
    if(w>baseViewBox.width)w=baseViewBox.width;if(h>baseViewBox.height)h=baseViewBox.height;
    const minX=baseViewBox.x,maxX=baseViewBox.x+baseViewBox.width-w,minY=baseViewBox.y,maxY=baseViewBox.y+baseViewBox.height-h;
    if(x<minX)x=minX;if(x>maxX)x=maxX;if(y<minY)y=minY;if(y>maxY)y=maxY;
    const sizeChanged=(w!==vb.width||h!==vb.height);
    vb={x,y,width:w,height:h};svg.setAttribute('viewBox',`${x} ${y} ${w} ${h}`);
    if(sizeChanged)renderMarkers();
  }
  function onWheel(e){
    e.preventDefault();
    const pt=svg.createSVGPoint();pt.x=e.clientX;pt.y=e.clientY;
    const sp=pt.matrixTransform(svg.getScreenCTM().inverse());
    const scale=(e.deltaY<0)?(1/ZOOM_FACTOR):ZOOM_FACTOR;
    let newW=vb.width*scale,newH=vb.height*scale;
    const minW=baseViewBox.width/ZOOM_MAX,minH=baseViewBox.height/ZOOM_MAX;
    if(newW<minW)newW=minW;if(newH<minH)newH=minH;
    const maxW=baseViewBox.width,maxH=baseViewBox.height;
    if(newW>maxW)newW=maxW;if(newH>maxH)newH=maxH;
    const kx=(sp.x-vb.x)/vb.width,ky=(sp.y-vb.y)/vb.height;
    const newX=sp.x-kx*newW,newY=sp.y-ky*newH;
    clampAndSetViewBox(newX,newY,newW,newH);
  }
  function onMouseDownPanOrMarkerStart(e){
    if((e.button===0&&spacePressed)||(e.button===2&&!e.shiftKey)){isPanning=true;panStart={x:e.clientX,y:e.clientY};panStartVB={...vb};e.preventDefault();}
  }
  function onMouseMoveAll(e){dragMoveMarkerIfNeeded(e);
    if(!isPanning)return;
    const dx=e.clientX-panStart.x,dy=e.clientY-panStart.y,m=svg.getScreenCTM();
    const sx=vb.width/(m.a*svg.clientWidth),sy=vb.height/(m.d*svg.clientHeight);
    clampAndSetViewBox(panStartVB.x-dx*sx,panStartVB.y-dy*sy,vb.width,vb.height);
  }
  function onMouseUpAll(){isPanning=false;dragStopIfNeeded();}
  function saveLocal(){localStorage.setItem(STORAGE_KEY,JSON.stringify(markers));}
  function loadLocal(){try{markers=JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');}catch(e){markers=[];}}
  async function loadFromSheet(){
    const qs=TOKEN?`?token=${encodeURIComponent(TOKEN)}&t=${Date.now()}`:`?t=${Date.now()}`;
    const res=await fetch(WEB_APP_URL+qs);if(!res.ok)throw new Error('GET failed');
    const data=await res.json();
    markers=Array.isArray(data.markers)?data.markers.map(m=>({
      id:m.id,
      px:+m.px,
      py:+m.py,
      visible:(m.visible===true||m.visible==="TRUE"||m.visible===1),
      createdAt:m.createdAt?+m.createdAt:Date.now()
    })):[];
    updateNextId();saveLocal();renderMarkers();
  }
  function formBody(p){const u=new URLSearchParams();Object.entries(p).forEach(([k,v])=>u.set(k,v));if(TOKEN)u.set('token',TOKEN);return u.toString();}
  function upsertRemote(m){
    fetch(WEB_APP_URL,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body:formBody({action:'upsert',payload:JSON.stringify({
        id:m.id,px:m.px,py:m.py,label:"",visible:m.visible,createdAt:m.createdAt||Date.now()
      })})
    }).catch(()=>{});
  }
})();
</script>
</body>
</html>
